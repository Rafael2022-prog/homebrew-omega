name: Update Homebrew Formula

on:
  repository_dispatch:
    types: [omega-release]
  workflow_dispatch:
    inputs:
      version:
        description: 'OMEGA version to update to'
        required: true
        default: '1.2.1'
      archive_url:
        description: 'Archive URL'
        required: false

jobs:
  update-formula:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout tap repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up environment
      run: |
        echo "VERSION=${{ github.event.inputs.version || github.event.client_payload.version }}" >> $GITHUB_ENV
        echo "ARCHIVE_URL=${{ github.event.inputs.archive_url || github.event.client_payload.archive_url }}" >> $GITHUB_ENV
        
    - name: Download and calculate hash
      run: |
        # Set default URL if not provided
        if [ -z "$ARCHIVE_URL" ]; then
          ARCHIVE_URL="https://github.com/Rafael2022-prog/omega-lang/archive/refs/tags/v${VERSION}.tar.gz"
        fi
        
        echo "Downloading: $ARCHIVE_URL"
        curl -L -o omega-${VERSION}.tar.gz "$ARCHIVE_URL"
        
        # Calculate SHA256
        SHA256=$(sha256sum omega-${VERSION}.tar.gz | cut -d' ' -f1)
        echo "SHA256: $SHA256"
        
        # Store in environment
        echo "ARCHIVE_URL=$ARCHIVE_URL" >> $GITHUB_ENV
        echo "SHA256=$SHA256" >> $GITHUB_ENV
        
    - name: Update formula
      run: |
        # Update the formula file
        sed -i "s|url \".*\"|url \"$ARCHIVE_URL\"|g" Formula/omega-lang.rb
        sed -i "s|sha256 \".*\"|sha256 \"$SHA256\"|g" Formula/omega-lang.rb
        sed -i "s|version \".*\"|version \"$VERSION\"|g" Formula/omega-lang.rb
        
        echo "Formula updated:"
        echo "- Version: $VERSION"
        echo "- URL: $ARCHIVE_URL"
        echo "- SHA256: $SHA256"
        
    - name: Validate formula
      run: |
        # Install Homebrew for validation
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> ~/.bashrc
        eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
        
        # Audit the formula (path-based audit is acceptable here in CI)
        brew audit --strict Formula/omega-lang.rb || echo "Audit completed with warnings"
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add Formula/omega-lang.rb
        git commit -m "Update OMEGA to v$VERSION

        - Update version to $VERSION
        - Update archive URL: $ARCHIVE_URL
        - Update SHA256 hash: $SHA256
        - Automated update via GitHub Actions"
        
        git push
        
    - name: Create release notes
      run: |
        cat > release-notes.md << EOF
        # OMEGA Homebrew Formula v$VERSION
        
        ## Changes
        - Updated OMEGA Language to version $VERSION
        - Updated archive URL and SHA256 hash
        - Validated formula syntax and dependencies
        
        ## Installation
        \`\`\`bash
        brew tap Rafael2022-prog/homebrew-omega
        brew install omega-lang
        \`\`\`
        
        ## Verification
        \`\`\`bash
        omega --version
        # Should output: OMEGA Language v$VERSION
        \`\`\`
        
        ## Archive Details
        - **URL**: $ARCHIVE_URL
        - **SHA256**: \`$SHA256\`
        - **Size**: $(ls -lh omega-${VERSION}.tar.gz | awk '{print $5}')
        
        ---
        
        This update was automatically generated by GitHub Actions.
        EOF
        
        echo "Release notes created:"
        cat release-notes.md
        
    - name: Notify completion
      run: |
        echo "âœ… Homebrew formula updated successfully!"
        echo "ðŸ“¦ Version: $VERSION"
        echo "ðŸ”— Archive: $ARCHIVE_URL"
        echo "ðŸ” SHA256: $SHA256"
        echo ""
        echo "ðŸº Users can now install with:"
        echo "   brew tap Rafael2022-prog/homebrew-omega"
        echo "   brew install omega-lang"